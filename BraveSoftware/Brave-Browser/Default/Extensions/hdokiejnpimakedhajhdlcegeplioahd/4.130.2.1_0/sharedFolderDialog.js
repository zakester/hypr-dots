var SharedFolderDialog=function(e){var t={additionalHeaderClasses:["icon"],nextButtonText:Strings.translateString("Save changes"),closeButtonEnabled:!0,maximizeButtonEnabled:!0,buttonAlign:this.RIGHT_ALIGN};Dialog.call(this,e,t),this.existingUsers=null,this.folder=null};SharedFolderDialog.prototype=Object.create(Dialog.prototype),SharedFolderDialog.prototype.constructor=SharedFolderDialog,function(r){SharedFolderDialog.prototype.initialize=function(e){var s,t,r;Dialog.prototype.initialize.apply(this,arguments),s=this,bg&&bg.get("g_prefoverrides")&&"1"===bg.get("g_prefoverrides").shareout&&(document.getElementById("maximumSharesOutsideOfCompanyInfo").style.display="none"),t=document.getElementById("sharedFolderDialogUserTypeahead"),LPProxy.isEnterpriseUser()?((r=new BloodhoundDropdown(t,{identify:function(e){return"group"===e.type?e.cgid:e.uid},remote:{url:LPProxy.getBaseURL()+"typeahead_remote.php?grp=1&q=%QUERY&checkemails=1",wildcard:"%QUERY"}},{optionLabel:function(e){var t=e.name;return"companyuser"===e.type?""===t?t=e.email:""!==e.email&&(t+=" ("+e.email+")"):t+=" ("+Strings.Vault.USER_GROUP+")",t},ignore:function(e,t){return s.existingUsers[e]||void 0===t.type}})).onChange(function(e,t){e=$.extend({},e);var r=SharedFolderUser,r=("group"===e.type&&(e.uid=e.cgid,delete e.cgid,r=SharedFolderUserGroup),e.username=e.email,delete e.email,new r(e,s.folder));r._pending=!0,s.addNewUser(r),s.existingUsers[t]=!0}),r.clear=function(){},s.inputFields.friends=r):s.inputFields.friends=r=new TypeaheadDropdown(t),LPProxy.isFamilyUser()?$("#sharedFolderDialogDisclaimer").show():$("#sharedFolderDialogDisclaimer").hide(),r.autocomplete=function(e){var t=e.target.value;if(null===this.hint&&t){for(var r=s.parseFriendsInput(t),i=0,n=r.length;i<n;++i)s.addNewUser(r[i]);e.preventDefault()}TypeaheadDropdown.prototype.autocomplete.apply(this,arguments)},Topics.get(Topics.REMOVED_SHARED_FOLDER_USER).subscribe(function(e){delete s.existingUsers[e.getID()],s.showHideInviteInput()}),$("#sharedFolderDialogInviteButton").bind("click",function(){s.submit()})},SharedFolderDialog.prototype.parseFriendsInput=function(e){for(var t=[],r=e.split(","),i=0,n=r.length;i<n;++i){var s=r[i].trim(),a,o,o,a;-1<s.indexOf("@")?(o=s.match(Constants.EmailAddressRegularExpression))&&1===o.length&&(o=o[0],a=new SharedFolderUser({username:o},this.folder)):s&&(a=new SharedFolderUserGroup({name:s},this.folder)),a&&(a._pending=!0,a.setEditable(!0),t.push(a))}return t},SharedFolderDialog.prototype.validate=function(e){var t=Dialog.prototype.validate.apply(this,arguments);return e.friends&&0===this.parseFriendsInput(e.friends).length&&(this.addError("friends",Strings.translateString("You must enter a valid email or group name.")),t=!1),t},SharedFolderDialog.prototype.defaultFields=function(e){e.defaultData=$.extend({readonly:!0,hidePasswords:!0},e.defaultData),Dialog.prototype.defaultFields.call(this,e)},SharedFolderDialog.prototype.addNewUser=function(e){this.containers.newMembers||(this.containers.newMembers=new Container([],{additionalItemClasses:"dialogItem"}),this.containers.newMembers.initialize(document.getElementById("sharedFolderDialogNewUsersContainer"))),this.containers.newMembers.addChild(e),this.inputFields.friends.focus()},SharedFolderDialog.prototype.setup=function(e,t){Dialog.prototype.setup.apply(this,arguments),this.containers.existingMembers&&(this.containers.existingMembers.initialize(r.getElementById("folderMembers")),this.showHideInviteInput())},SharedFolderDialog.prototype.showHideInviteInput=function(){LPProxy.isEnterpriseUser()||(5<this.containers.existingMembers.getItemChildren().length?($("#sharedFolderMaxMembers").show(),$("#sharedFolderDialogInvites").hide()):($("#sharedFolderMaxMembers").hide(),$("#sharedFolderDialogInvites").show()))},SharedFolderDialog.prototype.open=function(n){var s;this.folder=n,s=this,LPRequest.makeDataRequest(LPProxy.getSharedFolderMembers,{params:{shareid:n.getID()},success:function(e){for(var t=[],r=0,i=e.users.length;r<i;++r)t.push(new SharedFolderUser(e.users[r],n));for(var r=0,i=e.groups.length;r<i;++r)t.push(new SharedFolderUserGroup(e.groups[r],n));s.containers.existingMembers=new Container(t),s.existingUsers={};for(var r=0,i=t.length;r<i;++r)s.existingUsers[t[r].getID()]=!0;Dialog.prototype.open.call(s,{title:Strings.translateString("Manage recipients")+": "+s.folder.getShareGroupName()})},error:function(){Topics.get(Topics.DIALOG_LOADED).publish()}})},SharedFolderDialog.prototype.getInvitedMembers=function(){var e,e;return e=(e=this.containers.newMembers?this.containers.newMembers.getItems():[]).concat(this.parseFriendsInput(this.inputFields.friends.getValue()))},SharedFolderDialog.prototype.getData=function(){var t=document.getElementById("sharedFolderDialogHide"),r=document.getElementById("sharedFolderDialogReadOnly"),i=document.getElementById("sharedFolderDialogAdmin"),e=Dialog.prototype.getData.apply(this,arguments),n=(e.newMembers={},e.updatedPermissions=[],this.getInvitedMembers());if(0<n.length)for(var s=0,a=n.length;s<a;++s){var o=n[s];e.newMembers[o.getUsername()]={uid:o.getID(),type:o.getType()}}else for(var d=this.containers.existingMembers.getItemChildren(),s=0,a=d.length;s<a;++s){var l=d[s];l.isModified()&&e.updatedPermissions.push({uid:l.getID(!0),give:l.getCheckboxValue("give"),readonly:l.getCheckboxValue("readonly"),canadminister:LPProxy.isEnterpriseUser()?l.getCheckboxValue("can_administer"):"0"})}return i.addEventListener("click",function(e){"checkbox"===e.target.type&&i.checked&&(t.checked=!1,r.checked=!1)}),e},SharedFolderDialog.prototype.handleSubmit=function(a){var e=$.extend(a,{sharedFolder:this.folder._data,shareInfo:this.folder._shareInfo});LPTools.hasProperties(a.newMembers)?LPRequest.makeRequest(LPProxy.addSharedFolderMembers,{params:e,success:this.createDynamicHandler(function(e){for(var t=[],r=this.getInvitedMembers(),i=0,n=r.length;i<n;++i){var s=r[i];e[s.getUsername()]&&(s._pending=!1,s._data.readonly=a.readonly?"1":"0",s._data.give=a.hidePasswords?"0":"1",s._data.can_administer=a.can_administer?"1":"0",s.rebuild(),t.push(s)),s._parent&&s._parent.removeChild(s)}this.containers.existingMembers.addChild(t),this.showHideInviteInput()})}):0<a.updatedPermissions.length?LPRequest.makeRequest(LPProxy.updateSharedFolderMemberPermissions,{params:e,success:this.createHandler(function(){for(var e=this.containers.existingMembers.getItemChildren(),t={},r=0,i=e.length;r<i;++r){var n=e[r];t[n.getID(!0)]=n}for(var r=0,i=a.updatedPermissions.length;r<i;++r){var s=a.updatedPermissions[r];t[s.uid].updatePermissions(s)}})}):this.close(!0)},SharedFolderDialog.prototype.isModified=function(){var e=this.getData(),t=(delete e.newMembers[e.friends],e.friends="",this.getOriginalData());return this.differs(t,e)},SharedFolderDialog.prototype.showCloseConfirmation=function(e){dialogs.confirmation.open({title:Strings.translateString("You have unsaved changes"),text:Strings.translateString("Unsaved changes will be lost if you close before saving.\n\nPreviously sent invitations won't be affected."),nextButtonText:Strings.translateString("Discard changes"),backButtonText:Strings.translateString("Go back"),handler:this.createHandler(this.close,!0,e)})}}(document);