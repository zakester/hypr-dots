function PWCHANGER(){var h=2,m="",k=[],w="",v="",b="",T="",S="",E="",P=0,A=0,O="",x="",C=[],I=6e5,R=10,u="",g=[],K=!1,j=!1,N=!1,H="";function F(){return"undefined"!=typeof $?$.ajax:LPPlatform.doAjax}function _(n,t,r,o,a,e,i,s,u,c,d,p,l,f,y){var _=void 0!==l?l:"",g,h;void 0!==f&&f&&(R=f),"function"!=typeof i&&(i=function(){}),O=d=void 0!==d&&null!=d?d:"",x=p,m=s,"function"==typeof u&&u(0,0),L(r,t,o,e,function(e){var e;"string"!=typeof e?i(4,!1,!1,"A : Invalid Response"):"usernametaken"==e?i(1,!1,!1,"B : Username Taken"):("function"==typeof u&&u(0,1),e={oldkey:n,oldkey1:_,oldpwhash:t,oldemail:r,newemail:o,newpassword:a,callback:i,reencrypt:e,status:u,foundendmarker:!1},y&&(e.ks="true"),C=e,setTimeout(function(){q()},0))},function(e,n,t){i(2,!1,!1,"C : "+n+" suberror="+t)},c)}function L(r,o,a,i,s,u,c){var e=function(){var e=void 0!==o&&null!=o&&""!=o?{wxusername:r,wxhash:o}:{},n=(void 0!==c&&null!=c&&""!=c&&(e.vendor=c),m+"getaccts.php?changepw=1&changepw2=1&includersaprivatekeyenc=1&changeun="+(r!=a?encodeURIComponent(a):"")+"&resetrsakeys="+(i?"1":"0")+"&includeendmarker=1"),t;"undefined"!=typeof g_recovery_uid&&(n+="&recovery_uid="+encodeURIComponent(g_recovery_uid)),F()({url:n,type:"POST",data:e,timeout:3e5,success:"function"==typeof s?s:null,error:"function"==typeof u?u:null})};n(function(){t(function(){e()},u)},u)}function D(p,l,f,y,_){""===f&&y();var e=O||token,n;F()({url:m+"lmiapi/one-time-password",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({masterPasswordHash:f}),headers:{"X-CSRF-TOKEN":e},success:function(n,t){if("object"!=typeof n.oneTimePasswords)"function"==typeof _&&_(n,t,"Invalid one time password response");else if(g=[],0===n.oneTimePasswords.length)"function"==typeof y&&y();else{var e=[];try{for(var r=fix_username(C.newemail),o=0;o<n.oneTimePasswords.length;o++){var a=n.oneTimePasswords[o],i={},s=dec(a.encryptedOneTimePassword,p),u=AES.hex2bin(s),c=make_lp_hash(r,u),d=make_lp_key(r,u);a.oneTimePasswordHash=c,a.randomEncryptedKey=enc(AES.bin2hex(p),d),i.encryptedOneTimePassword=enc(s,l),i.randomEncryptedKey=enc(AES.bin2hex(l),d),i.oneTimePasswordHash=c,e.push(i),g.push(a)}}catch(e){return void("function"==typeof _&&_(n,t,"OTP Encryption failed"))}G(e,f,y,_)}},error:function(e,n){"function"==typeof _&&_(e,n,"GET one time passwords failed")}})}function X(e){0!==g.length?G(g,C.oldpwhash,e,function(){"function"==typeof e&&e()}):"function"==typeof e&&e()}function G(e,n,t,r){""===n&&t();var e=JSON.stringify({oneTimePasswords:e,masterPasswordHash:n}),n=O||token,o;F()({url:m+"lmiapi/one-time-password/update",type:"POST",contentType:"application/json",headers:{"X-CSRF-TOKEN":n},data:e,dataType:"json",success:t,error:function(e,n){"function"==typeof r&&r(e,n,"POST new one time passwords failed")}})}function U(o,a,i,s){var e=O||token,n;F()({url:m+"lmiapi/authenticator/backup",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":e},success:function(n,t){var e;try{u=n.userData;var r=dec(n.userData,o),e=enc(r,a)}catch(e){return void("function"==typeof s&&s(n,t,"Encryption failed"))}c(e,i,s)},error:function(e,n){e.status&&404==e.status?"function"==typeof i&&i():"function"==typeof s&&s(e,n,"GET new LP cloud backup failed")}})}function J(e){u?c(u,e,function(){"function"==typeof e&&e()}):"function"==typeof e&&e()}function c(e,n,t){var e=JSON.stringify({userData:e}),r=O||token,o;F()({url:m+"lmiapi/authenticator/backup",type:"POST",contentType:"application/json",headers:{"X-CSRF-TOKEN":r},data:e,dataType:"json",success:n,error:function(e,n){"function"==typeof t&&t(e,n,"POST new LP cloud backup failed")}})}function M(){var e,n=C.callback;"function"==typeof n&&n(2,!1,!1,null)}function q(){try{var e,n;if(2==h&&(k=C.reencrypt.split("\n"),"number"==typeof g_target_key_iterations&&(I=g_target_key_iterations,"undefined"!=typeof g_key_iterations)&&g_key_iterations!=g_target_key_iterations&&(C.iterationschange="1"),S=C.newkey||make_lp_key_iterations(fix_username(C.newemail),C.newpassword,I),w+=k[0]+"\n",""!=(e=k[1]))&&(""==(n=rsa_extract_privatekey(e,C.oldkey))&&""!=C.oldkey1&&(n=rsa_extract_privatekey(e,C.oldkey1)),H=""==n?(v="","failed"):(v=rsa_encrypt_privatekey(n,S),n=null,"success"),b=SHA256(AES.bin2hex(S).toUpperCase()),T=SHA256(v)),void 0===k.length)C.callback(2,!1,!1,"F2 : internal error");else{var t,r,o=!1,a=F();try{enc(" ",S)?o=!0:logger.error("encrypting space failed",{})}catch(e){logger.error("space encryption exception",{error:e})}for(var i=h+3,s=0,u,c,d;h<k.length&&h<i;++h){var p,f=k[h].replace(/\r\n|\r|\n/g,"").split("\t");if("endmarker"==(l=f[0]))C.foundendmarker=!0;else{var y=void 0!==f.length&&2<=f.length&&"0"==f[1];if(void 0!==l.length&&l.length){var _=null,g;if(o)try{t=dec(l,C.oldkey),r=enc(t,S),t!==dec(r,S)&&(E+="enc: "+l+" decrypted value does not match reencryption and decryption with new key",P++,s++)}catch(e){_=e,logger.error("reencrypt exception",{})}o&&null==_&&AES.ok(r)&&0!=r.length&&null!=t&&void 0!==t.length&&0!=t.length||(y||(o?null!=(t=dec(l,S))&&void 0!==t.length&&0!=t.length||(E+="enc: "+l+" decrypted:  reencrypted to: "+r+(null==_?"":" : EXCEPTION_A!")+"\n"):(g=void 0===S.length?"undefined":S.length,E+="encrypting <space> using m_newkey (m_newkey.length="+g+") resulted in EXCEPTION_B!\n"),P++),r=o?l:""),y||A++,w+=l+":"+r+"\n","function"==typeof C.status&&C.status(1,(h-1)/(k.length-2))}}}s&&logger.error("reencrypt error: different output",{reDecyptionIssues:s}),h<k.length?setTimeout(function(){q()},0):C.foundendmarker?(void 0!==R&&(R||0===R)||(R=10),u=O||token,""!==E&&logger.error("m_errors: "+E,{m_errors:E}),""!=E&&A/100*R<=P?(c={from:"passwordChange",errors:E,username:C.oldemail,private_key_status:H,total:k.length-2,mandatory_total:A,mandatory_failed:P,super_admin_reset:j?"yes":"no"},a({url:m+"debug.php",data:c,type:"POST",timeout:6e5,headers:{"X-CSRF-TOKEN":u},success:function(e){},error:function(e,n){}}),d=SHA256(C.oldemail)+"_from_mp_migration",null!=localStorage.getItem(d)&&a({url:m+"lmiapi/users/master-password-unset",type:"DELETE",timeout:6e5,headers:{"X-CSRF-TOKEN":u},success:function(){localStorage.removeItem(d),logger.info("MP migration with corruption: remove pwresetreqd success")},error:function(){logger.error("MP migration with corruption: remove pwresetreqd failed")}}),"function"==typeof C.callback&&C.callback(3,null,null,"E : "+E)):(logger.info("Re encryption finished.",{}),U(C.oldkey,S,function(){C.iterationschange?D(C.oldkey,S,C.oldpwhash,B,M):B()},M))):"function"==typeof C.callback&&C.callback(2,!1,!1,"D : Data download not complete")}}catch(e){C.callback(2,!1,!1,"F : "+e.message)}}this.hashMigration=function(t,r,o,a,i,e,n,s,u,c){var d,p,l;void 0===c&&(c=""),K=N=j=!1,m=e,O=n,I=s,R=0,"function"!=typeof u&&(u=function(){}),t===a?u(!1,"Hash migration already happened? Maybe stale extension data"):L(o,r,o,!(d=function(e,n,t,r){0===e?u(!0):u(!1,r)}),function(e){var n;"string"!=typeof e?u(!1,"Invalid response"):"usernametaken"==e?u(!1,"Username taken or deleted during hash migration"):(C={oldkey:t,oldkey1:c,oldpwhash:r,oldemail:o,newemail:o,newkey:a,newpwhash:i,callback:d,reencrypt:e,foundendmarker:!1,iterationschange:"1",hashmigration:"1"},setTimeout(function(){q()},0))},function(){u(!1,"Error retrieving accounts data during hash migration")})},this.recoveryChangePassword=function(e,n,t,r,o,a,i,s){var u="",c,d=N=j=!(K=!0);_(e,n,t,t,r,!1,o,"",a,null,i,s)},this.superAdminPasswordReset=function(e,n,t,r,o,a,i,s){var u="",c,d="",p=N=!(j=!(K=!1));_(e,"",n,t,r,!1,o,"",a,null,i,s)},this.setInitialPassword=function(e,n,t,r,o,a,i,s){var u="",c,d="",p=!(N=!(j=K=!1));_(e,"",n,t,r,!1,o,"",a,null,i,s)},this.changepw=function(e,n,t,r,o,a,i,s,u,c,d,p,l,f,y){N=j=K=!1,_(e,n,t,r,o,a,i,s,u,c,d,p,l,f,y)};var n=function(n,t){var e;Array.isArray(window.g_su_pubkeys)&&Array.isArray(window.g_su_uids)?n():F()({url:m+"lmiapi/users/me/publicsharingkeys",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":O},success:function(e){window.g_su_pubkeys=e.map(function(e){return e.publicSharingKey}),window.g_su_uids=e.map(function(e){return e.userId}),n&&n()},error:function(e,n){M(),t&&t(e,n,"Cannot GET sharing keys")}})},t=function(t,r){var e;Array.isArray(window.g_lu_pubkeys)&&Array.isArray(window.g_lu_uids)?t():(window.g_lu_pubkeys=[],window.g_lu_uids=[],F()({url:m+"lmiapi/emergency-access/sharees",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":O},success:function(e){e.forEach(function(e){window.g_lu_pubkeys.push(e.publicSharingKey),window.g_lu_uids.push(e.userId)}),t&&t()},error:function(e,n){404===e.status?t():(M(),r&&r(e,n,"Request for emergency access keys failed"))}}))};function B(){logger.info("Update data to server.",{});var e=C.newpwhash||make_lp_hash_iterations(S,C.newpassword,I),r={reencrypt:w,newprivatekeyenc:v,newuserkeyhexhash:b,newprivatekeyenchexhash:T,newpasswordhash:e,pwupdate:"1",email:C.newemail,token:O,encrypted_username:encecb(C.newemail,S),origusername:C.oldemail,key_iterations:I},o;if(C.iterationschange&&(r.iterationschange=C.iterationschange),C.hashmigration&&(r.hashmigration=C.hashmigration,r.ks=!0),K&&(r.is_recovery="1"),j&&(r.superAdminReset="1",g_converttosftargetuid)){var n=make_lp_key_iterations(C.newemail,C.newpassword,I),e=make_lp_hash_iterations(n,C.newpassword,I);if(r.converttosfbythissharename=lpenc("Shared-SF from deleted "+C.newemail+" "+g_recovery_uid,n),r.converttosfbythispasswordhash=e,"undefined"!=typeof g_sasf_uids&&"undefined"!=typeof g_sasf_pubkeys&&"undefined"!=typeof g_sasf_uids_cnt){for(var t=0;t<g_sasf_uids_cnt;t++){var a=new RSAKey,i=(parse_public_key(a,g_sasf_pubkeys[t])||lpmessagebox(gs("An Error Occurred"),gs("We are sorry, an error occurred - Cannot parse public key.")),a.encrypt(AES.bin2hex(n)));r["adminsharekey"+t]=i,r["adminuid"+t]=g_sasf_uids[t]}r.adminuidcnt=g_sasf_uids_cnt}var e=new RSAKey;parse_public_key(e,g_targetuid_pubkey)?(r.converttosfbythistargetuid=g_converttosftargetuid,r.converttosfbythistargetuidsharekey=e.encrypt(AES.bin2hex(n))):lpmessagebox(gs("An Error Occurred"),gs("We are sorry, an error occurred - Cannot parse public key."))}if(N&&(r.setInitialPassword="1"),void 0!==C.oldpwhash&&null!=C.oldpwhash&&""!=C.oldpwhash&&(r.wxusername=C.oldemail,r.wxhash=C.oldpwhash),void 0!==C.ks&&C.ks&&(r.ks="true"),void 0!==x&&null!=x&&(r.password_hint=x),"undefined"!=typeof g_su_pubkeys&&null!=g_su_pubkeys&&g_su_pubkeys.length){for(var s=!1,o=0,u=0,a;u<g_su_pubkeys.length;u++){""!=g_su_pubkeys[u]&&(a=new RSAKey,parse_public_key(a,g_su_pubkeys[u]))&&(r["sukey"+o]=a.encrypt(AES.bin2hex(S)),r["suuid"+o]=g_su_uids[u],s=!0,o++)}if(r.sukeycnt=o,0==s&&"function"==typeof C.callback)return void C.callback(2,!1,!1,gs("Before your LastPass administrator can set up account recovery, all users who are Administrators must log in to a browser extension at least once."))}"undefined"!=typeof g_lu_pubkeys&&null!=g_lu_pubkeys&&(o=0,g_lu_pubkeys.forEach(function(e,n){var t;e&&(t=new RSAKey,parse_public_key(t,e))&&(r["lukey"+o]=t.encrypt(AES.bin2hex(S)),r["luuid"+o]=g_lu_uids[n],o++)}),r.lukeycnt=o),"undefined"!=typeof g_recovery_uid&&(r.recovery_uid=g_recovery_uid),"undefined"!=typeof g_changeiterations&&1==g_changeiterations&&(r.iterationschange="1"),"undefined"==typeof g_sapr_pwd||"undefined"==typeof g_sapr_newpwd||g_converttosftargetuid||("undefined"!=typeof g_defederate&&1==g_defederate?(r.to_be_defederated=1,r.defed_pwdlastset=g_sapr_lastPwdSet):(r.to_be_federated=1,r.fed_keyALP=g_sapr_keyALP,r.fed_keyLP=g_sapr_keyLP,r.fed_keyLPCheckHash=g_sapr_keyLPCheckHash,r.fed_fragmentId=g_sapr_fragmentId,r.fed_pwdlastset=g_sapr_lastPwdSet)),document.URL.includes("familiesinvite=1")&&(r.familiesinvite=1),"undefined"!=typeof fromcid&&(r.cid=fromcid),"undefined"!=typeof g_oid_fragmentId&&(r.fedOId_fragmentId=g_oid_fragmentId),"undefined"!=typeof g_encryptedK2&&"undefined"!=typeof g_oidcresponse&&void 0!==g_oidcresponse.id_token&&(r.fedOId_encryptedKC2=g_encryptedK2,r.fedOId_idToken=g_oidcresponse.id_token),"undefined"!=typeof g_isFederatedEmailChng&&(r.fedEmailChange=g_isFederatedEmailChng);var c=C.callback,d=S,p=C.newemail,l=C.status,f=(C=new Array,k=new Array,h=2,E=S=w="",A=P=0,"function"==typeof l&&l(2,0),generateOtpData(p,d)),y=F(),_=(f.lmiapiData.masterPasswordHash=r.wxhash,y({url:m+"lmiapi/one-time-password/add",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify(f.lmiapiData),headers:{"X-CSRF-TOKEN":r.token},success:function(){localStorage.setItem(SHA256(p)+"_otp",AES.bin2hex(f.OTP)),_(f.lmiapiData.oneTimePasswordHash)},error:function(){_()}}),function(e){e&&(r.not_to_be_deleted_otp_hash=e),y({url:m+"settings.php",data:r,type:"POST",timeout:6e5,success:function(e){"function"==typeof l&&l(2,1),-1==e.indexOf("pwchangeok")?0<=e.indexOf("reusepass")?J(function(){X(function(){c(2,!1,!1,"H : "+e.split("\n")[1])})}):0==e.indexOf("error\n")?J(function(){X(function(){c(2,!1,!1,e.split("\n")[1])})}):J(function(){X(function(){c(2,!1,!1,"I : An error occured")})}):"function"==typeof c&&c(0,d,p)},error:function(e,n,t){J(function(){X(function(){"function"==typeof c&&c(2,!1,!1,"J : "+n+" suberror="+t)})})}})})}}String.prototype.includes||(String.prototype.includes=function(e,n){"use strict";return!((n="number"!=typeof n?0:n)+e.length>this.length)&&-1!==this.indexOf(e,n)});